  360          
  361          frame_set = []
  362          reward_set = []
  363          test_env = Environment(self.game_id, train=False)
  364          for _ in range(trial):
  365              state = test_env.reset()
  366              frames = []
  367              test_step = 0
  368              test_reward = 0
  369              done = False
  370              test_memory = ReplayMemory(10000, verbose=False)
  371              while not done:
  372                  frames.append(test_env.render())
  373                  action = self.get_action(tf.constant(state, tf.float32), tf.constant(0.0, tf.float32))
  374                  next_state, reward, done, info = test_env.step(action)
  375                  test_reward += reward
  376                  test_memory.push(state, action, reward, next_state, done)
  377                  state = next_state
  378                  test_step += 1
  379                  if done and self.life_game and (info["ale.lives"] != 0):
  380                      test_env.reset()
  381                      test_step = 0
  382                      done = False
  383                  if len(frames) > 15 * 60 * max_playing_time:
  384                      print("Playing takes {} minutes. Force termination.".format(max_playing_time))
  385                      break
  386              reward_set.append(test_reward)
  387              frame_set.append(frames)
  388          best_score = np.max(reward_set)
  389          print("Best score of current network ({} trials): {}".format(trial, best_score))
  390          best_score_ind = np.argmax(reward_set)
  391          imageio.mimsave("test_dqn.gif", frame_set[best_score_ind], fps=15)
  392          if episode is not None:
  393              with self.summary_writer.as_default():
  394                  tf.summary.scalar("Test score", best_score, step=episode)
  395      def write_summary(self, episode, latest_100_score, episode_score, total_step, eps):
  396          with self.summary_writer.as_default():
  397              tf.summary.scalar("Reward (clipped)", episode_score, step=episode)
  398              tf.summary.scalar("Latest 100 avg reward (clipped)", np.mean(latest_100_score), step=episode)
  399              tf.summary.scalar("Loss", self.loss_metric.result(), step=episode)
  400              tf.summary.scalar("Average Q", self.q_metric.result(), step=episode)
  401              tf.summary.scalar("Total Frames", total_step, step=episode)
  402              tf.summary.scalar("Epsilon", eps, step=episode)
  403          self.loss_metric.reset_states()
  404          self.q_metric.reset_states()
  405  EOF
  406  cat > /root/Deep/main.py << 'EOF'
  407  import argparse
  408  from ddqn.agent.ddqn_agent import Agent
  409  from ddqn.agent.dqn_agent import DQNAgent
  410  def args_parse():
  411      parser = argparse.ArgumentParser(description="Atari: DQN vs DDQN")
  412      parser.add_argument('--env', default="BreakoutNoFrameskip-v4", help='Should be NoFrameskip environment')
  413      parser.add_argument('--algorithm', default="ddqn", choices=["dqn", "ddqn"], help='Algorithm to use: dqn or ddqn')
  414      parser.add_argument('--train', action="store_true", help='Train agent with given environment')
  415      parser.add_argument('--play', help="Play with a given weight directory")
  416      parser.add_argument('--log_interval', default=100, help="Interval of logging stdout", type=int)
  417      parser.add_argument('--save_weight_interval', default=1000, help="Interval of saving weights", type=int)
  418      args = parser.parse_args()
  419      return args
  420  if __name__ == "__main__":
  421      args = args_parse()
  422      
  423      # Select algorithm
  424      if args.algorithm == "dqn":
  425          print("Using DQN algorithm")
  426          agent = DQNAgent(args.env)
  427      else:
  428          print("Using Double DQN algorithm")
  429          agent = Agent(args.env)
  430      
  431      agent.print_log_interval = args.log_interval
  432      agent.save_weight_interval = args.save_weight_interval
  433      
  434      if args.train:
  435          print("Start training")
  436          agent.train()
  437      if args.play:
  438          print("Start playing")
  439          agent.play(args.play)
  440  EOF
  441  cat > /root/Deep/reproduce_figure3.sh << 'EOF'
  442  #!/bin/bash
  443  # ============================================================================
  444  # å¤çŽ°è®ºæ–‡å›¾3å®žéªŒè„šæœ¬
  445  # Deep Reinforcement Learning with Double Q-learning (arXiv:1509.06461)
  446  # 
  447  # å›¾3å†…å®¹ï¼š
  448  # - é¡¶éƒ¨ä¸¤è¡Œï¼šDQNï¼ˆæ©™è‰²ï¼‰ä¸Ž Double DQNï¼ˆè“è‰²ï¼‰çš„ä»·å€¼ä¼°è®¡å¯¹æ¯”
  449  # - åº•éƒ¨ä¸€è¡Œï¼šå®žé™…æ¸¸æˆå¾—åˆ†å¯¹æ¯”
  450  # - æ¸¸æˆï¼šAlien, Space Invaders, Time Pilot, Zaxxon, Wizard of Wor, Asterix
  451  # ============================================================================
  452  # æ¿€æ´»çŽ¯å¢ƒ
  453  source /root/miniconda3/bin/activate deep
  454  # è®¾ç½® cuDNN çŽ¯å¢ƒå˜é‡
  455  export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:/root/miniconda3/envs/deep/lib/python3.8/site-packages/nvidia/cudnn/lib:/root/miniconda3/envs/deep/lib/python3.8/site-packages/nvidia/cublas/lib
  456  # è¿›å…¥é¡¹ç›®ç›®å½•
  457  cd /root/Deep
  458  # å®šä¹‰å›¾3ä¸­çš„6ä¸ªæ¸¸æˆ
  459  GAMES=(
  460      "AlienNoFrameskip-v4"
  461      "SpaceInvadersNoFrameskip-v4"
  462      "TimePilotNoFrameskip-v4"
  463      "ZaxxonNoFrameskip-v4"
  464      "WizardOfWorNoFrameskip-v4"
  465      "AsterixNoFrameskip-v4"
  466  )
  467  # å®šä¹‰ç®—æ³•
  468  ALGORITHMS=("dqn" "ddqn")
  469  echo "=============================================="
  470  echo "å¼€å§‹å¤çŽ°è®ºæ–‡å›¾3å®žéªŒ"
  471  echo "å…± ${#GAMES[@]} ä¸ªæ¸¸æˆ Ã— ${#ALGORITHMS[@]} ä¸ªç®—æ³• = $((${#GAMES[@]} * ${#ALGORITHMS[@]})) ä¸ªå®žéªŒ"
  472  echo "å¼€å§‹æ—¶é—´: $(date)"
  473  echo "=============================================="
  474  # å¾ªçŽ¯è®­ç»ƒæ¯ä¸ªæ¸¸æˆçš„ä¸¤ç§ç®—æ³•
  475  for game in "${GAMES[@]}"; do
  476      for algo in "${ALGORITHMS[@]}"; do
  477          echo ""
  478          echo "=========================================="
  479          echo "æ¸¸æˆ: $game"
  480          echo "ç®—æ³•: $algo"
  481          echo "å¼€å§‹æ—¶é—´: $(date)"
  482          echo "=========================================="
  483          
  484          python main.py --env "$game" --algorithm "$algo" --train --log_interval 100 --save_weight_interval 1000
  485          
  486          echo "å®Œæˆ: $game ($algo)"
  487          echo "ç»“æŸæ—¶é—´: $(date)"
  488          echo ""
  489      done
  490  done
  491  echo "=============================================="
  492  echo "æ‰€æœ‰å®žéªŒå®Œæˆ!"
  493  echo "ç»“æŸæ—¶é—´: $(date)"
  494  echo ""
  495  echo "æŸ¥çœ‹ç»“æžœ:"
  496  echo "  tensorboard --logdir=./log/ --host 0.0.0.0 --port 6006"
  497  echo "=============================================="
  498  EOF
  499  chmod +x /root/Deep/reproduce_figure3.sh
  500  cat > /root/Deep/plot_figure3.py << 'EOF'
  501  """
  502  ç»˜åˆ¶è®ºæ–‡å›¾3ï¼šDQN vs Double DQN å¯¹æ¯”å›¾
  503  è®ºæ–‡å›¾3å†…å®¹ï¼š
  504  - é¡¶éƒ¨ä¸¤è¡Œï¼šDQNï¼ˆæ©™è‰²ï¼‰ä¸Ž Double DQNï¼ˆè“è‰²ï¼‰çš„ä»·å€¼ä¼°è®¡ï¼ˆAverage Q valueï¼‰
  505  - åº•éƒ¨ä¸€è¡Œï¼šå®žé™…æ¸¸æˆå¾—åˆ†ï¼ˆRewardï¼‰
  506  æ¸¸æˆï¼šAlien, Space Invaders, Time Pilot, Zaxxon, Wizard of Wor, Asterix
  507  """
  508  import os
  509  import glob
  510  import numpy as np
  511  import matplotlib.pyplot as plt
  512  from tensorboard.backend.event_processing import event_accumulator
  513  # è®¾ç½®ä¸­æ–‡å­—ä½“ï¼ˆå¦‚æžœéœ€è¦ï¼‰
  514  plt.rcParams['font.sans-serif'] = ['SimHei', 'DejaVu Sans']
  515  plt.rcParams['axes.unicode_minus'] = False
  516  # æ¸¸æˆåˆ—è¡¨ï¼ˆä¸Žè®ºæ–‡å›¾3ä¸€è‡´ï¼‰
  517  GAMES = {
  518      'Alien': 'AlienNoFrameskip-v4',
  519      'Space Invaders': 'SpaceInvadersNoFrameskip-v4',
  520      'Time Pilot': 'TimePilotNoFrameskip-v4',
  521      'Zaxxon': 'ZaxxonNoFrameskip-v4',
  522      'Wizard of Wor': 'WizardOfWorNoFrameskip-v4',
  523      'Asterix': 'AsterixNoFrameskip-v4',
  524  }
  525  def load_tensorboard_data(log_dir, tag):
  526      """ä»ŽTensorBoardæ—¥å¿—åŠ è½½æ•°æ®"""
  527      ea = event_accumulator.EventAccumulator(log_dir)
  528      ea.Reload()
  529      
  530      if tag not in ea.Tags()['scalars']:
  531          return None, None
  532      
  533      events = ea.Scalars(tag)
  534      steps = [e.step for e in events]
  535      values = [e.value for e in events]
  536      return np.array(steps), np.array(values)
  537  def find_log_dir(base_path, game_env, algorithm):
  538      """æŸ¥æ‰¾å¯¹åº”çš„æ—¥å¿—ç›®å½•"""
  539      pattern = f"{base_path}/*_{algorithm.upper()}_{game_env}" if algorithm == "dqn" else f"{base_path}/*_{game_env}"
  540      
  541      if algorithm == "dqn":
  542          pattern = f"{base_path}/*_DQN_{game_env}"
  543      else:
  544          # DDQNæ—¥å¿—ä¸åŒ…å«"DQN_"å‰ç¼€
  545          dirs = glob.glob(f"{base_path}/*_{game_env}")
  546          dirs = [d for d in dirs if "_DQN_" not in d]
  547          if dirs:
  548              return sorted(dirs)[-1] + "/summary/"
  549          return None
  550      
  551      dirs = glob.glob(pattern)
  552      if dirs:
  553          return sorted(dirs)[-1] + "/summary/"
  554      return None
  555  def smooth_data(values, weight=0.9):
  556      """æŒ‡æ•°ç§»åŠ¨å¹³å‡å¹³æ»‘"""
  557      smoothed = []
  558      last = values[0]
  559      for v in values:
  560          smoothed_val = last * weight + (1 - weight) * v
  561          smoothed.append(smoothed_val)
  562          last = smoothed_val
  563      return np.array(smoothed)
  564  def plot_figure3(log_base_path="./log"):
  565      """ç»˜åˆ¶è®ºæ–‡å›¾3"""
  566      
  567      fig, axes = plt.subplots(3, 6, figsize=(20, 10))
  568      fig.suptitle('Figure 3: DQN (orange) vs Double DQN (blue) Comparison', fontsize=14)
  569      
  570      games = list(GAMES.keys())
  571      
  572      for col, game_name in enumerate(games):
  573          game_env = GAMES[game_name]
  574          
  575          # æŸ¥æ‰¾æ—¥å¿—ç›®å½•
  576          dqn_dir = find_log_dir(log_base_path, game_env, "dqn")
  577          ddqn_dir = find_log_dir(log_base_path, game_env, "ddqn")
  578          
  579          # ç¬¬ä¸€è¡Œï¼šAverage Q value (ä»·å€¼ä¼°è®¡)
  580          ax1 = axes[0, col]
  581          ax1.set_title(game_name, fontsize=10)
  582          if col == 0:
  583              ax1.set_ylabel('Average Q\nValue Estimate', fontsize=9)
  584          
  585          if dqn_dir and os.path.exists(dqn_dir):
  586              steps, values = load_tensorboard_data(dqn_dir, 'Average Q')
  587              if steps is not None:
  588                  smoothed = smooth_data(values)
  589                  ax1.plot(steps, smoothed, color='orange', alpha=0.8, label='DQN')
  590                  ax1.fill_between(steps, values.min(), smoothed, color='orange', alpha=0.2)
  591          
  592          if ddqn_dir and os.path.exists(ddqn_dir):
  593              steps, values = load_tensorboard_data(ddqn_dir, 'Average Q')
  594              if steps is not None:
  595                  smoothed = smooth_data(values)
  596                  ax1.plot(steps, smoothed, color='blue', alpha=0.8, label='DDQN')
  597                  ax1.fill_between(steps, values.min(), smoothed, color='blue', alpha=0.2)
  598          
  599          # ç¬¬äºŒè¡Œï¼šä¹Ÿæ˜¯ Average Qï¼ˆè®ºæ–‡å›¾3ä¸­é—´ä¸¤è¡Œéƒ½æ˜¯Qå€¼ï¼‰
  600          ax2 = axes[1, col]
  601          if col == 0:
  602              ax2.set_ylabel('Average Q\n(zoomed)', fontsize=9)
  603          
  604          if dqn_dir and os.path.exists(dqn_dir):
  605              steps, values = load_tensorboard_data(dqn_dir, 'Average Q')
  606              if steps is not None:
  607                  smoothed = smooth_data(values)
  608                  ax2.plot(steps, smoothed, color='orange', alpha=0.8)
  609          
  610          if ddqn_dir and os.path.exists(ddqn_dir):
  611              steps, values = load_tensorboard_data(ddqn_dir, 'Average Q')
  612              if steps is not None:
  613                  smoothed = smooth_data(values)
  614                  ax2.plot(steps, smoothed, color='blue', alpha=0.8)
  615          
  616          # ç¬¬ä¸‰è¡Œï¼šå®žé™…å¾—åˆ†
  617          ax3 = axes[2, col]
  618          if col == 0:
  619              ax3.set_ylabel('Score\n(Reward)', fontsize=9)
  620          ax3.set_xlabel('Training Steps\n(in millions)', fontsize=8)
  621          
  622          if dqn_dir and os.path.exists(dqn_dir):
  623              steps, values = load_tensorboard_data(dqn_dir, 'Latest 100 avg reward (clipped)')
  624              if steps is not None:
  625                  smoothed = smooth_data(values)
  626                  ax3.plot(steps, smoothed, color='orange', alpha=0.8, label='DQN')
  627                  ax3.fill_between(steps, 0, smoothed, color='orange', alpha=0.2)
  628          
  629          if ddqn_dir and os.path.exists(ddqn_dir):
  630              steps, values = load_tensorboard_data(ddqn_dir, 'Latest 100 avg reward (clipped)')
  631              if steps is not None:
  632                  smoothed = smooth_data(values)
  633                  ax3.plot(steps, smoothed, color='blue', alpha=0.8, label='DDQN')
  634                  ax3.fill_between(steps, 0, smoothed, color='blue', alpha=0.2)
  635      
  636      # æ·»åŠ å›¾ä¾‹
  637      handles = [
  638          plt.Line2D([0], [0], color='orange', linewidth=2, label='DQN'),
  639          plt.Line2D([0], [0], color='blue', linewidth=2, label='Double DQN')
  640      ]
  641      fig.legend(handles=handles, loc='upper right', fontsize=10)
  642      
  643      plt.tight_layout(rect=[0, 0, 1, 0.96])
  644      
  645      # ä¿å­˜å›¾ç‰‡
  646      output_path = './figure3_reproduction.png'
  647      plt.savefig(output_path, dpi=150, bbox_inches='tight')
  648      print(f"å›¾3å·²ä¿å­˜åˆ°: {output_path}")
  649      
  650      plt.show()
  651  if __name__ == "__main__":
  652      plot_figure3("./log")
  653  EOF
  654  cat > /root/Deep/è¯´æ˜Žæ–‡æ¡£.md << 'ENDOFFILE'
  655  # DDQN é¡¹ç›®å®Œæ•´å®‰è£…ä¸Žè¿è¡ŒæŒ‡å—
  656  > **Deep Reinforcement Learning with Double Q-learning** é¡¹ç›®å¤çŽ°æ–‡æ¡£
  657  >
  658  > è®ºæ–‡ï¼š[Deep Reinforcement Learning with Double Q-learning](https://arxiv.org/abs/1509.06461)
  659  ---
  660  ## ðŸ“‹ ç›®å½•
  661  1. [çŽ¯å¢ƒå‡†å¤‡](#1-çŽ¯å¢ƒå‡†å¤‡)
  662  2. [ä¾èµ–å®‰è£…](#2-ä¾èµ–å®‰è£…)
  663  3. [Atari ROMs é…ç½®](#3-atari-roms-é…ç½®)
  664  4. [GPU æ”¯æŒé…ç½®](#4-gpu-æ”¯æŒé…ç½®)
  665  5. [è¿è¡Œè®­ç»ƒ](#5-è¿è¡Œè®­ç»ƒ)
  666  6. [å¤çŽ°è®ºæ–‡å›¾3å®žéªŒ](#6-å¤çŽ°è®ºæ–‡å›¾3å®žéªŒ)
  667  7. [ä½¿ç”¨è®­ç»ƒå¥½çš„æ¨¡åž‹](#7-ä½¿ç”¨è®­ç»ƒå¥½çš„æ¨¡åž‹)
  668  8. [æŸ¥çœ‹è®­ç»ƒç»“æžœ](#8-æŸ¥çœ‹è®­ç»ƒç»“æžœ)
  669  9. [å¸¸è§é—®é¢˜è§£å†³](#9-å¸¸è§é—®é¢˜è§£å†³)
  670  10. [çŽ¯å¢ƒä¿¡æ¯](#10-çŽ¯å¢ƒä¿¡æ¯)
  671  ---
  672  ## 1. çŽ¯å¢ƒå‡†å¤‡
  673  > ðŸŽ¯ **ç›®æ ‡**ï¼šåˆ›å»ºç‹¬ç«‹çš„ Python è™šæ‹ŸçŽ¯å¢ƒï¼Œé¿å…åŒ…å†²çª
  674  ### æ­¥éª¤ 1.1ï¼šåˆ›å»º Conda è™šæ‹ŸçŽ¯å¢ƒ
  675  ```bash
  676  conda create -n deep python=3.8 -y
  677  ```
  678  ### æ­¥éª¤ 1.2ï¼šæ¿€æ´»çŽ¯å¢ƒ
  679  ```bash
  680  conda activate deep
  681  ```
  682  âœ… **éªŒè¯**ï¼šå‘½ä»¤è¡Œå‰ç¼€åº”æ˜¾ç¤º `(deep)`
  683  ---
  684  ## 2. ä¾èµ–å®‰è£…
  685  > ðŸŽ¯ **ç›®æ ‡**ï¼šå®‰è£…é¡¹ç›®è¿è¡Œæ‰€éœ€çš„ Python åŒ…
  686  ### æ­¥éª¤ 2.1ï¼šå®‰è£… OpenAI Gymï¼ˆæ¸¸æˆçŽ¯å¢ƒï¼‰
  687  ```bash
  688  pip install gym==0.15.3 -i https://pypi.tuna.tsinghua.edu.cn/simple
  689  ```
  690  ### æ­¥éª¤ 2.2ï¼šå®‰è£…ä¸»è¦ä¾èµ–åŒ…
  691  ```bash
  692  pip install imageio tensorflow numpy opencv-python matplotlib atari-py -i https://pypi.tuna.tsinghua.edu.cn/simple
  693  ```
  694  ### æ­¥éª¤ 2.3ï¼šå®‰è£… Loggerï¼ˆæ—¥å¿—å·¥å…·ï¼‰
  695  ```bash
  696  pip install logger -i https://pypi.tuna.tsinghua.edu.cn/simple
  697  ```
  698  âœ… **éªŒè¯**ï¼šè¿è¡Œ `pip list | grep tensorflow` åº”æ˜¾ç¤º tensorflow ç‰ˆæœ¬
  699  ---
  700  ## 3. Atari ROMs é…ç½®
  701  > ðŸŽ¯ **ç›®æ ‡**ï¼šä¸‹è½½å¹¶é…ç½® Atari æ¸¸æˆ ROM æ–‡ä»¶ï¼ˆæ¸¸æˆæœ¬ä½“ï¼‰
  702  ### æ­¥éª¤ 3.1ï¼šå®‰è£… AutoROM å·¥å…·
  703  ```bash
  704  pip install autorom[accept-rom-license] -i https://pypi.tuna.tsinghua.edu.cn/simple
  705  ```
  706  ### æ­¥éª¤ 3.2ï¼šä¸‹è½½ ROMs
  707  ```bash
  708  AutoROM --accept-license
  709  ```
  710  ### æ­¥éª¤ 3.3ï¼šå¯¼å…¥ ROMs åˆ° atari_py
  711  ```bash
  712  python -m atari_py.import_roms /root/miniconda3/envs/deep/lib/python3.8/site-packages/AutoROM/roms
  713  ```
  714  âœ… **éªŒè¯**ï¼šè¿è¡Œä»¥ä¸‹å‘½ä»¤åº”æ— æŠ¥é”™
  715  ```bash
  716  python -c "import atari_py; print(atari_py.get_game_path('breakout'))"
  717  ```
  718  ---
  719  ## 4. GPU æ”¯æŒé…ç½®
  720  > ðŸŽ¯ **ç›®æ ‡**ï¼šé…ç½® cuDNNï¼Œè®© TensorFlow èƒ½ä½¿ç”¨ GPU åŠ é€Ÿè®­ç»ƒ
  721  ### æ­¥éª¤ 4.1ï¼šå®‰è£… cuDNN
  722  ```bash
  723  pip install nvidia-cudnn-cu11==8.6.0.163 -i https://pypi.tuna.tsinghua.edu.cn/simple
  724  ```
  725  ### æ­¥éª¤ 4.2ï¼šè®¾ç½®çŽ¯å¢ƒå˜é‡ï¼ˆæ¯æ¬¡è¿è¡Œå‰æ‰§è¡Œï¼‰
  726  ```bash
  727  export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:/root/miniconda3/envs/deep/lib/python3.8/site-packages/nvidia/cudnn/lib:/root/miniconda3/envs/deep/lib/python3.8/site-packages/nvidia/cublas/lib
  728  ```
  729  ### æ­¥éª¤ 4.3ï¼šï¼ˆå¯é€‰ï¼‰æ°¸ä¹…ç”Ÿæ•ˆ
  730  ```bash
  731  echo 'export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:/root/miniconda3/envs/deep/lib/python3.8/site-packages/nvidia/cudnn/lib:/root/miniconda3/envs/deep/lib/python3.8/site-packages/nvidia/cublas/lib' >> ~/.bashrc
  732  source ~/.bashrc
  733  ```
  734  âœ… **éªŒè¯**ï¼šè¿è¡Œä»¥ä¸‹å‘½ä»¤åº”æ˜¾ç¤º GPU ä¿¡æ¯
  735  ```bash
  736  python -c "import tensorflow as tf; print(tf.config.list_physical_devices('GPU'))"
  737  ```
  738  ---
  739  ## 5. è¿è¡Œè®­ç»ƒ
  740  > ðŸŽ¯ **ç›®æ ‡**ï¼šå¯åŠ¨ DQN/DDQN ç®—æ³•è®­ç»ƒ Atari æ¸¸æˆ
  741  ### æ­¥éª¤ 5.1ï¼šè¿›å…¥é¡¹ç›®ç›®å½•
  742  ```bash
  743  cd /root/Deep
  744  ```
  745  ### æ­¥éª¤ 5.2ï¼šæŸ¥çœ‹å‘½ä»¤å¸®åŠ©
  746  ```bash
  747  python main.py --help
  748  ```
  749  è¾“å‡ºè¯´æ˜Žï¼š
  750  | å‚æ•° | è¯´æ˜Ž |
  751  |------|------|
  752  | `--env` | æ¸¸æˆçŽ¯å¢ƒåç§°ï¼ˆå¿…é¡»æ˜¯ NoFrameskip ç‰ˆæœ¬ï¼‰ |
  753  | `--algorithm` | ç®—æ³•é€‰æ‹©ï¼š`dqn` æˆ– `ddqn`ï¼ˆé»˜è®¤ ddqnï¼‰ |
  754  | `--train` | å¯åŠ¨è®­ç»ƒæ¨¡å¼ |
  755  | `--play` | ä½¿ç”¨å·²è®­ç»ƒçš„æƒé‡è¿›è¡Œæ¸¸æˆ |
  756  | `--log_interval` | æ—¥å¿—è¾“å‡ºé—´éš”ï¼ˆæ¯ N ä¸ª Episodeï¼‰ |
  757  | `--save_weight_interval` | æƒé‡ä¿å­˜é—´éš”ï¼ˆæ¯ N ä¸ª Episodeï¼‰ |
  758  ### æ­¥éª¤ 5.3ï¼šå¼€å§‹è®­ç»ƒ
  759  **æ–¹å¼ä¸€ï¼šä½¿ç”¨ Double DQNï¼ˆé»˜è®¤ï¼ŒæŽ¨èï¼‰**
  760  ```bash
  761  python main.py --env BreakoutNoFrameskip-v4 --train
  762  ```
  763  **æ–¹å¼äºŒï¼šä½¿ç”¨æ ‡å‡† DQNï¼ˆç”¨äºŽå¯¹æ¯”å®žéªŒï¼‰**
  764  ```bash
  765  python main.py --env BreakoutNoFrameskip-v4 --algorithm dqn --train
  766  ```
  767  **æ–¹å¼ä¸‰ï¼šè‡ªå®šä¹‰å‚æ•°**
  768  ```bash
  769  python main.py --env BreakoutNoFrameskip-v4 --algorithm ddqn --train --log_interval 100 --save_weight_interval 1000
  770  ```
  771  ---
  772  ## 6. å¤çŽ°è®ºæ–‡å›¾3å®žéªŒ
  773  > ðŸŽ¯ **ç›®æ ‡**ï¼šå¤çŽ°è®ºæ–‡å›¾3ä¸­ DQN ä¸Ž Double DQN åœ¨å…­æ¬¾æ¸¸æˆä¸Šçš„å¯¹æ¯”å®žéªŒ
  774  >
  775  > **å›¾3å±•ç¤ºå†…å®¹ï¼š**
  776  > - **é¡¶éƒ¨ä¸¤è¡Œ**ï¼šDQNï¼ˆæ©™è‰²ï¼‰ä¸Ž Double DQNï¼ˆè“è‰²ï¼‰çš„**ä»·å€¼ä¼°è®¡ï¼ˆQå€¼ï¼‰**å¯¹æ¯”
  777  > - **åº•éƒ¨ä¸€è¡Œ**ï¼š**å®žé™…æ¸¸æˆå¾—åˆ†**å¯¹æ¯”
  778  > - **æ ¸å¿ƒç»“è®º**ï¼šDQN ä¼š**è¿‡é«˜ä¼°è®¡** Q å€¼ï¼Œè€Œ Double DQN ä¼°è®¡æ›´**å‡†ç¡®**ã€å­¦ä¹ æ›´**ç¨³å®š**
  779  ### ðŸ“Š å›¾3ä¸­çš„6ä¸ªæ¸¸æˆ
  780  | åºå· | æ¸¸æˆåç§° | çŽ¯å¢ƒåç§° | è¯´æ˜Ž |
  781  |------|----------|----------|------|
  782  | 1 | Alien | `AlienNoFrameskip-v4` | å¤–æ˜Ÿäºº |
  783  | 2 | Space Invaders | `SpaceInvadersNoFrameskip-v4` | å¤ªç©ºä¾µç•¥è€… |
  784  | 3 | Time Pilot | `TimePilotNoFrameskip-v4` | æ—¶é—´é£žè¡Œå‘˜ |
  785  | 4 | Zaxxon | `ZaxxonNoFrameskip-v4` | æ‰Žå…‹æ¾ |
  786  | 5 | Wizard of Wor | `WizardOfWorNoFrameskip-v4` | å·«å¸ˆä¹‹æˆ˜ |
  787  | 6 | Asterix | `AsterixNoFrameskip-v4` | é˜¿æ–¯æ³°é‡Œå…‹æ–¯ |
  788  ---
  789  ### ðŸš€ æ–¹æ³•ä¸€ï¼šä¸€é”®è¿è¡Œå…¨éƒ¨å®žéªŒï¼ˆæŽ¨èï¼‰
  790  > ä½¿ç”¨æ‰¹é‡è„šæœ¬è‡ªåŠ¨è®­ç»ƒ6ä¸ªæ¸¸æˆÃ—2ç§ç®—æ³•=12ä¸ªå®žéªŒ
  791  ```bash
  792  cd /root/Deep
  793  # åŽå°è¿è¡Œï¼ˆæŽ¨èï¼Œæ–­å¼€SSHä¹Ÿä¸ä¼šä¸­æ–­ï¼‰
  794  nohup ./reproduce_figure3.sh > training_log.txt 2>&1 &
  795  # æŸ¥çœ‹è®­ç»ƒè¿›åº¦
  796  tail -f training_log.txt
  797  ```
  798  ---
  799  ### ðŸ“ æ–¹æ³•äºŒï¼šæ‰‹åŠ¨é€æ­¥è¿è¡Œ
  800  #### æ­¥éª¤ 6.1ï¼šè®­ç»ƒ Alienï¼ˆå¤–æ˜Ÿäººï¼‰
  801  ```bash
  802  cd /root/Deep
  803  # DQN ç‰ˆæœ¬
  804  python main.py --env AlienNoFrameskip-v4 --algorithm dqn --train --log_interval 100 --save_weight_interval 1000
  805  # Double DQN ç‰ˆæœ¬
  806  python main.py --env AlienNoFrameskip-v4 --algorithm ddqn --train --log_interval 100 --save_weight_interval 1000
  807  ```
  808  #### æ­¥éª¤ 6.2ï¼šè®­ç»ƒ Space Invadersï¼ˆå¤ªç©ºä¾µç•¥è€…ï¼‰
  809  ```bash
  810  # DQN
  811  python main.py --env SpaceInvadersNoFrameskip-v4 --algorithm dqn --train --log_interval 100 --save_weight_interval 1000
  812  # Double DQN
  813  python main.py --env SpaceInvadersNoFrameskip-v4 --algorithm ddqn --train --log_interval 100 --save_weight_interval 1000
  814  ```
  815  #### æ­¥éª¤ 6.3ï¼šè®­ç»ƒ Time Pilotï¼ˆæ—¶é—´é£žè¡Œå‘˜ï¼‰
  816  ```bash
  817  # DQN
  818  python main.py --env TimePilotNoFrameskip-v4 --algorithm dqn --train --log_interval 100 --save_weight_interval 1000
  819  # Double DQN
  820  python main.py --env TimePilotNoFrameskip-v4 --algorithm ddqn --train --log_interval 100 --save_weight_interval 1000
  821  ```
  822  #### æ­¥éª¤ 6.4ï¼šè®­ç»ƒ Zaxxonï¼ˆæ‰Žå…‹æ¾ï¼‰
  823  ```bash
  824  # DQN
  825  python main.py --env ZaxxonNoFrameskip-v4 --algorithm dqn --train --log_interval 100 --save_weight_interval 1000
  826  # Double DQN
  827  python main.py --env ZaxxonNoFrameskip-v4 --algorithm ddqn --train --log_interval 100 --save_weight_interval 1000
  828  ```
  829  #### æ­¥éª¤ 6.5ï¼šè®­ç»ƒ Wizard of Worï¼ˆå·«å¸ˆä¹‹æˆ˜ï¼‰
  830  ```bash
  831  # DQN
  832  python main.py --env WizardOfWorNoFrameskip-v4 --algorithm dqn --train --log_interval 100 --save_weight_interval 1000
  833  # Double DQN
  834  python main.py --env WizardOfWorNoFrameskip-v4 --algorithm ddqn --train --log_interval 100 --save_weight_interval 1000
  835  ```
  836  #### æ­¥éª¤ 6.6ï¼šè®­ç»ƒ Asterixï¼ˆé˜¿æ–¯æ³°é‡Œå…‹æ–¯ï¼‰
  837  ```bash
  838  # DQN
  839  python main.py --env AsterixNoFrameskip-v4 --algorithm dqn --train --log_interval 100 --save_weight_interval 1000
  840  # Double DQN
  841  python main.py --env AsterixNoFrameskip-v4 --algorithm ddqn --train --log_interval 100 --save_weight_interval 1000
  842  ```
  843  ---
  844  ### ðŸ“ˆ æ­¥éª¤ 6.7ï¼šç”Ÿæˆå›¾3
  845  è®­ç»ƒå®ŒæˆåŽï¼Œè¿è¡Œç»˜å›¾è„šæœ¬ç”Ÿæˆå¯¹æ¯”å›¾ï¼š
  846  ```bash
  847  cd /root/Deep
  848  python plot_figure3.py
  849  ```
  850  **è¾“å‡ºæ–‡ä»¶**ï¼š`./figure3_reproduction.png`
  851  ---
  852  ### â±ï¸ é¢„è®¡è®­ç»ƒæ—¶é—´
  853  | é…ç½® | å•ä¸ªå®žéªŒ | å…¨éƒ¨12ä¸ªå®žéªŒ |
  854  |------|----------|--------------|
  855  | RTX 3090 | çº¦ 10-20 å°æ—¶ | çº¦ 5-10 å¤© |
  856  | RTX 4090 | çº¦ 6-12 å°æ—¶ | çº¦ 3-6 å¤© |
  857  **è¯´æ˜Ž**ï¼š
  858  - é»˜è®¤è®­ç»ƒ 10,000,000 å¸§
  859  - è®ºæ–‡åŽŸå§‹å®žéªŒè®­ç»ƒäº† 200,000,000 å¸§ï¼ˆçº¦20å€ï¼‰
  860  - å¦‚éœ€å®Œæ•´å¤çŽ°ï¼Œä¿®æ”¹ `ddqn/agent/ddqn_agent.py` ä¸­çš„ `self.training_frames`
  861  ---
  862  ### ðŸ”¬ DQN ä¸Ž Double DQN çš„æ ¸å¿ƒåŒºåˆ«
  863  | ç®—æ³• | ç›®æ ‡Qå€¼è®¡ç®— | é—®é¢˜ |
  864  |------|-------------|------|
  865  | **DQN** | $Y = r + \gamma \max_{a'} Q_{target}(s', a')$ | ä½¿ç”¨åŒä¸€ç½‘ç»œé€‰æ‹©åŠ¨ä½œå’Œè¯„ä¼°ï¼Œå¯¼è‡´**è¿‡é«˜ä¼°è®¡** |
  866  | **Double DQN** | $Y = r + \gamma Q_{target}(s', \arg\max_{a'} Q_{online}(s', a'))$ | åˆ†ç¦»åŠ¨ä½œé€‰æ‹©å’Œè¯„ä¼°ï¼Œä¼°è®¡æ›´**å‡†ç¡®** |
  867  **ä»£ç ä½ç½®**ï¼š
  868  - DQN: `ddqn/agent/dqn_agent.py` ç¬¬ 80-85 è¡Œ
  869  - DDQN: `ddqn/agent/ddqn_agent.py` ç¬¬ 80-90 è¡Œ
  870  ---
  871  ## 7. ä½¿ç”¨è®­ç»ƒå¥½çš„æ¨¡åž‹
  872  > ðŸŽ¯ **ç›®æ ‡**ï¼šåŠ è½½å·²è®­ç»ƒçš„æƒé‡ï¼Œè§‚çœ‹ AI çŽ©æ¸¸æˆ
  873  ### æ­¥éª¤ 7.1ï¼šæŸ¥çœ‹ä¿å­˜çš„æƒé‡ç›®å½•
  874  ```bash
  875  ls -la /root/Deep/log/
  876  ```
  877  è¾“å‡ºç¤ºä¾‹ï¼š
  878  ```
  879  drwxr-xr-x 4 root root 48 Jan  1 14:06 20260101_140258_BreakoutNoFrameskip-v4
  880  drwxr-xr-x 4 root root 48 Jan  1 15:30 20260101_153000_DQN_AlienNoFrameskip-v4
  881  drwxr-xr-x 4 root root 48 Jan  1 16:00 20260101_160000_AlienNoFrameskip-v4
  882  ```
  883  **å‘½åè§„åˆ™**ï¼š
  884  - `æ—¶é—´æˆ³_DQN_æ¸¸æˆå` = DQN è®­ç»ƒç»“æžœ
  885  - `æ—¶é—´æˆ³_æ¸¸æˆå` = Double DQN è®­ç»ƒç»“æžœ
  886  ### æ­¥éª¤ 7.2ï¼šä½¿ç”¨æƒé‡è¿›è¡Œæ¸¸æˆ
  887  ```bash
  888  # Double DQN æ¨¡åž‹
  889  python main.py --env BreakoutNoFrameskip-v4 --play ./log/20260101_140258_BreakoutNoFrameskip-v4/weights
  890  # DQN æ¨¡åž‹
  891  python main.py --env AlienNoFrameskip-v4 --algorithm dqn --play ./log/20260101_153000_DQN_AlienNoFrameskip-v4/weights
  892  ```
  893  ---
  894  ## 8. æŸ¥çœ‹è®­ç»ƒç»“æžœ
  895  > ðŸŽ¯ **ç›®æ ‡**ï¼šä½¿ç”¨ TensorBoard å¯è§†åŒ–è®­ç»ƒè¿‡ç¨‹
  896  ### æ­¥éª¤ 8.1ï¼šå¯åŠ¨ TensorBoard
  897  ```bash
  898  tensorboard --logdir=./log/ --host 0.0.0.0 --port 6006
  899  ```
  900  ### æ­¥éª¤ 8.2ï¼šè®¿é—® TensorBoard
  901  - æœ¬åœ°è®¿é—®ï¼šhttp://localhost:6006/
  902  - è¿œç¨‹æœåŠ¡å™¨ï¼šhttp://[æœåŠ¡å™¨IP]:6006/
  903  ### æ­¥éª¤ 8.3ï¼šå¯¹æ¯” DQN ä¸Ž Double DQN
  904  åœ¨ TensorBoard å·¦ä¾§å‹¾é€‰å¤šä¸ªå®žéªŒè¿›è¡Œå¯¹æ¯”ï¼š
  905  | æŒ‡æ ‡ | å¯¹åº”å›¾3å†…å®¹ | é¢„æœŸå·®å¼‚ |
  906  |------|-------------|----------|
  907  | **Average Q** | é¡¶éƒ¨ä¸¤è¡Œï¼ˆQå€¼ä¼°è®¡ï¼‰ | DQN æ˜Žæ˜¾**è¿‡é«˜**ï¼ŒDDQN æ›´æŽ¥è¿‘çœŸå®žå€¼ |
  908  | **Latest 100 avg reward** | åº•éƒ¨ä¸€è¡Œï¼ˆå¾—åˆ†ï¼‰ | DDQN æ›´**ç¨³å®š**ï¼Œæœ€ç»ˆå¾—åˆ†æ›´é«˜ |
  909  | **Loss** | è®­ç»ƒæŸå¤± | DDQN æ”¶æ•›æ›´**å¹³ç¨³** |
  910  ---
  911  ## 9. å¸¸è§é—®é¢˜è§£å†³
  912  ### âŒ é—®é¢˜ 1: ModuleNotFoundError: No module named 'gym'
  913  ```bash
  914  pip install gym==0.15.3 -i https://pypi.tuna.tsinghua.edu.cn/simple
  915  ```
  916  ### âŒ é—®é¢˜ 2: ModuleNotFoundError: No module named 'imageio'
  917  ```bash
  918  pip install imageio -i https://pypi.tuna.tsinghua.edu.cn/simple
  919  ```
  920  ### âŒ é—®é¢˜ 3: ModuleNotFoundError: No module named 'logger'
  921  ```bash
  922  pip install logger -i https://pypi.tuna.tsinghua.edu.cn/simple
  923  ```
  924  ### âŒ é—®é¢˜ 4: ROM is missing for breakout / alien / å…¶ä»–æ¸¸æˆ
  925  ```bash
  926  pip install autorom[accept-rom-license] -i https://pypi.tuna.tsinghua.edu.cn/simple
  927  AutoROM --accept-license
  928  python -m atari_py.import_roms /root/miniconda3/envs/deep/lib/python3.8/site-packages/AutoROM/roms
  929  ```
  930  ### âŒ é—®é¢˜ 5: DNN library is not found
  931  ```bash
  932  pip install nvidia-cudnn-cu11==8.6.0.163 -i https://pypi.tuna.tsinghua.edu.cn/simple
  933  export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:/root/miniconda3/envs/deep/lib/python3.8/site-packages/nvidia/cudnn/lib:/root/miniconda3/envs/deep/lib/python3.8/site-packages/nvidia/cublas/lib
  934  ```
  935  ### âš ï¸ é—®é¢˜ 6: TF-TRT Warning: Could not find TensorRT
  936  è¿™åªæ˜¯è­¦å‘Šï¼Œä¸å½±å“è®­ç»ƒã€‚å¯å¿½ç•¥ã€‚
  937  ### âŒ é—®é¢˜ 7: Unknown environment (æ¸¸æˆçŽ¯å¢ƒä¸å­˜åœ¨)
  938  ç¡®ä¿ä½¿ç”¨ `NoFrameskip-v4` åŽç¼€ï¼š
  939  ```bash
  940  # âŒ é”™è¯¯
  941  python main.py --env Alien --train
  942  # âœ… æ­£ç¡®
  943  python main.py --env AlienNoFrameskip-v4 --train
  944  ```
  945  ---
  946  ## 10. çŽ¯å¢ƒä¿¡æ¯
  947  | é¡¹ç›® | ç‰ˆæœ¬/ä¿¡æ¯ |
  948  |------|-----------|
  949  | Python | 3.8 |
  950  | TensorFlow | 2.13.1 |
  951  | Gym | 0.15.3 |
  952  | cuDNN | 8600 |
  953  | GPU | NVIDIA GeForce RTX 3090 (22GB) |
  954  | CUDA Compute Capability | 8.6 |
  955  ---
  956  ## ðŸš€ å¿«é€Ÿå¼€å§‹
  957  ### ä¸€é”®å®‰è£…è„šæœ¬
  958  ```bash
  959  #!/bin/bash
  960  conda create -n deep python=3.8 -y
  961  conda activate deep
  962  pip install gym==0.15.3 imageio tensorflow numpy opencv-python matplotlib atari-py logger -i https://pypi.tuna.tsinghua.edu.cn/simple
  963  pip install autorom[accept-rom-license] nvidia-cudnn-cu11==8.6.0.163 -i https://pypi.tuna.tsinghua.edu.cn/simple
  964  AutoROM --accept-license
  965  python -m atari_py.import_roms /root/miniconda3/envs/deep/lib/python3.8/site-packages/AutoROM/roms
  966  echo 'export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:/root/miniconda3/envs/deep/lib/python3.8/site-packages/nvidia/cudnn/lib:/root/miniconda3/envs/deep/lib/python3.8/site-packages/nvidia/cublas/lib' >> ~/.bashrc
  967  source ~/.bashrc
  968  ```
  969  ### ä¸€é”®å¤çŽ°å›¾3
  970  ```bash
  971  cd /root/Deep
  972  nohup ./reproduce_figure3.sh > training_log.txt 2>&1 &
  973  ```
  974  ---
  975  ## ðŸ“š å‚è€ƒèµ„æ–™
  976  - è®ºæ–‡ï¼š[Deep Reinforcement Learning with Double Q-learning](https://arxiv.org/abs/1509.06461)
  977  - ä½œè€…ï¼šHado van Hasselt, Arthur Guez, David Silver (DeepMind)
  978  - å‘è¡¨ï¼šAAAI 2016
  979  - Double Q-learning åŽŸè®ºæ–‡ï¼š[NIPS 2010](https://papers.nips.cc/paper/3964-double-q-learning)
  980  ---
  981  *æ–‡æ¡£æ›´æ–°æ—¶é—´ï¼š2026-01-01*
  982  ENDOFFILE
  983  ls -la /root/Deep/ddqn/agent/
  984  cat /root/Deep/main.py && echo "---" && head -80 /root/Deep/ddqn/agent/dqn_agent.py
  985  ls -la /root/Deep/*.py /root/Deep/*.sh 2>/dev/null
  986  cat /root/Deep/reproduce_figure3.sh
  987  cat /root/Deep/plot_figure3.py
  988  source /root/miniconda3/bin/activate deep && export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:/root/miniconda3/envs/deep/lib/python3.8/site-packages/nvidia/cudnn/lib:/root/miniconda3/envs/deep/lib/python3.8/site-packages/nvidia/cublas/lib && cd /root/Deep && python main.py --help
  989  cat > /root/Deep/è¯´æ˜Žæ–‡æ¡£.md << 'ENDOFFILE'
  990  # å¤çŽ°è®ºæ–‡å›¾3ï¼šDeep Reinforcement Learning with Double Q-learning
  991  > **è®ºæ–‡**ï¼š[Deep Reinforcement Learning with Double Q-learning](https://arxiv.org/abs/1509.06461)
  992  >
  993  > **å›¾3å†…å®¹**ï¼šDQNï¼ˆæ©™è‰²ï¼‰ä¸Ž Double DQNï¼ˆè“è‰²ï¼‰åœ¨6æ¬¾Atariæ¸¸æˆä¸Šçš„å¯¹æ¯”
  994  ---
  995  ## ðŸ“‹ ç›®å½•
  996  1. [çŽ¯å¢ƒå‡†å¤‡](#1-çŽ¯å¢ƒå‡†å¤‡)
  997  2. [ä¾èµ–å®‰è£…](#2-ä¾èµ–å®‰è£…)
  998  3. [Atari ROMs é…ç½®](#3-atari-roms-é…ç½®)
  999  4. [GPU æ”¯æŒé…ç½®](#4-gpu-æ”¯æŒé…ç½®)
 1000  5. [å¤çŽ°å›¾3å®žéªŒ](#5-å¤çŽ°å›¾3å®žéªŒ)
 1001  6. [ç”Ÿæˆå›¾3](#6-ç”Ÿæˆå›¾3)
 1002  7. [å¸¸è§é—®é¢˜](#7-å¸¸è§é—®é¢˜)
 1003  ---
 1004  ## 1. çŽ¯å¢ƒå‡†å¤‡
 1005  > ðŸŽ¯ **ç›®æ ‡**ï¼šåˆ›å»º Python 3.8 è™šæ‹ŸçŽ¯å¢ƒ
 1006  ```bash
 1007  # æ­¥éª¤ 1.1ï¼šåˆ›å»ºçŽ¯å¢ƒ
 1008  conda create -n deep python=3.8 -y
 1009  # æ­¥éª¤ 1.2ï¼šæ¿€æ´»çŽ¯å¢ƒ
 1010  conda activate deep
 1011  ```
 1012  âœ… **éªŒè¯**ï¼šå‘½ä»¤è¡Œå‰ç¼€æ˜¾ç¤º `(deep)`
 1013  ---
 1014  ## 2. ä¾èµ–å®‰è£…
 1015  > ðŸŽ¯ **ç›®æ ‡**ï¼šå®‰è£…è®­ç»ƒæ‰€éœ€çš„ Python åŒ…
 1016  ```bash
 1017  # æ­¥éª¤ 2.1ï¼šå®‰è£… gym
 1018  pip install gym==0.15.3 -i https://pypi.tuna.tsinghua.edu.cn/simple
 1019  # æ­¥éª¤ 2.2ï¼šå®‰è£…ä¸»è¦ä¾èµ–
 1020  pip install imageio tensorflow numpy opencv-python matplotlib atari-py -i https://pypi.tuna.tsinghua.edu.cn/simple
 1021  # æ­¥éª¤ 2.3ï¼šå®‰è£… logger
 1022  pip install logger -i https://pypi.tuna.tsinghua.edu.cn/simple
 1023  ```
 1024  ---
 1025  ## 3. Atari ROMs é…ç½®
 1026  > ðŸŽ¯ **ç›®æ ‡**ï¼šä¸‹è½½æ¸¸æˆ ROM æ–‡ä»¶
 1027  ```bash
 1028  # æ­¥éª¤ 3.1ï¼šå®‰è£… AutoROM
 1029  pip install autorom[accept-rom-license] -i https://pypi.tuna.tsinghua.edu.cn/simple
 1030  # æ­¥éª¤ 3.2ï¼šä¸‹è½½ ROMs
 1031  AutoROM --accept-license
 1032  # æ­¥éª¤ 3.3ï¼šå¯¼å…¥ ROMs
 1033  python -m atari_py.import_roms /root/miniconda3/envs/deep/lib/python3.8/site-packages/AutoROM/roms
 1034  ```
 1035  ---
 1036  ## 4. GPU æ”¯æŒé…ç½®
 1037  > ðŸŽ¯ **ç›®æ ‡**ï¼šé…ç½® cuDNN å¯ç”¨ GPU åŠ é€Ÿ
 1038  ```bash
 1039  # æ­¥éª¤ 4.1ï¼šå®‰è£… cuDNN
 1040  pip install nvidia-cudnn-cu11==8.6.0.163 -i https://pypi.tuna.tsinghua.edu.cn/simple
 1041  # æ­¥éª¤ 4.2ï¼šè®¾ç½®çŽ¯å¢ƒå˜é‡ï¼ˆæ¯æ¬¡è¿è¡Œå‰æ‰§è¡Œï¼‰
 1042  export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:/root/miniconda3/envs/deep/lib/python3.8/site-packages/nvidia/cudnn/lib:/root/miniconda3/envs/deep/lib/python3.8/site-packages/nvidia/cublas/lib
 1043  ```
 1044  ---
 1045  ## 5. å¤çŽ°å›¾3å®žéªŒ
 1046  > ðŸŽ¯ **ç›®æ ‡**ï¼šåœ¨6æ¬¾æ¸¸æˆä¸Šåˆ†åˆ«è®­ç»ƒ DQN å’Œ Double DQNï¼Œå¤çŽ°è®ºæ–‡å›¾3
 1047  >
 1048  > **å›¾3å±•ç¤ºçš„å†…å®¹**ï¼š
 1049  > - é¡¶éƒ¨ä¸¤è¡Œï¼šä»·å€¼ä¼°è®¡ï¼ˆAverage Q valueï¼‰å¯¹æ¯”
 1050  > - åº•éƒ¨ä¸€è¡Œï¼šå®žé™…æ¸¸æˆå¾—åˆ†å¯¹æ¯”
 1051  > - æ©™è‰² = DQNï¼Œè“è‰² = Double DQN
 1052  ### ðŸ“Š å®žéªŒæ¸¸æˆåˆ—è¡¨ï¼ˆå…±6ä¸ªï¼‰
 1053  | æ¸¸æˆ | çŽ¯å¢ƒåç§° |
 1054  |------|----------|
 1055  | Alien | `AlienNoFrameskip-v4` |
 1056  | Space Invaders | `SpaceInvadersNoFrameskip-v4` |
 1057  | Time Pilot | `TimePilotNoFrameskip-v4` |
 1058  | Zaxxon | `ZaxxonNoFrameskip-v4` |
 1059  | Wizard of Wor | `WizardOfWorNoFrameskip-v4` |
 1060  | Asterix | `AsterixNoFrameskip-v4` |
 1061  ---
 1062  ### æ–¹æ³•ä¸€ï¼šä¸€é”®è¿è¡Œå…¨éƒ¨å®žéªŒï¼ˆæŽ¨èï¼‰
 1063  ```bash
 1064  cd /root/Deep
 1065  # åŽå°è¿è¡Œå…¨éƒ¨å®žéªŒï¼ˆ6æ¸¸æˆ Ã— 2ç®—æ³• = 12ä¸ªå®žéªŒï¼‰
 1066  nohup ./reproduce_figure3.sh > figure3_training.log 2>&1 &
 1067  # æŸ¥çœ‹è®­ç»ƒè¿›åº¦
 1068  tail -f figure3_training.log
 1069  ```
 1070  ---
 1071  ### æ–¹æ³•äºŒï¼šé€ä¸ªè¿è¡Œå®žéªŒ
 1072  #### æ­¥éª¤ 5.1ï¼šè®­ç»ƒ Alien
 1073  ```bash
 1074  cd /root/Deep
 1075  # DQN
 1076  python main.py --env AlienNoFrameskip-v4 --algorithm dqn --train --log_interval 100 --save_weight_interval 1000
 1077  # Double DQN
 1078  python main.py --env AlienNoFrameskip-v4 --algorithm ddqn --train --log_interval 100 --save_weight_interval 1000
 1079  ```
 1080  #### æ­¥éª¤ 5.2ï¼šè®­ç»ƒ Space Invaders
 1081  ```bash
 1082  # DQN
 1083  python main.py --env SpaceInvadersNoFrameskip-v4 --algorithm dqn --train --log_interval 100 --save_weight_interval 1000
 1084  # Double DQN
 1085  python main.py --env SpaceInvadersNoFrameskip-v4 --algorithm ddqn --train --log_interval 100 --save_weight_interval 1000
 1086  ```
 1087  #### æ­¥éª¤ 5.3ï¼šè®­ç»ƒ Time Pilot
 1088  ```bash
 1089  # DQN
 1090  python main.py --env TimePilotNoFrameskip-v4 --algorithm dqn --train --log_interval 100 --save_weight_interval 1000
 1091  # Double DQN
 1092  python main.py --env TimePilotNoFrameskip-v4 --algorithm ddqn --train --log_interval 100 --save_weight_interval 1000
 1093  ```
 1094  #### æ­¥éª¤ 5.4ï¼šè®­ç»ƒ Zaxxon
 1095  ```bash
 1096  # DQN
 1097  python main.py --env ZaxxonNoFrameskip-v4 --algorithm dqn --train --log_interval 100 --save_weight_interval 1000
 1098  # Double DQN
 1099  python main.py --env ZaxxonNoFrameskip-v4 --algorithm ddqn --train --log_interval 100 --save_weight_interval 1000
 1100  ```
 1101  #### æ­¥éª¤ 5.5ï¼šè®­ç»ƒ Wizard of Wor
 1102  ```bash
 1103  # DQN
 1104  python main.py --env WizardOfWorNoFrameskip-v4 --algorithm dqn --train --log_interval 100 --save_weight_interval 1000
 1105  # Double DQN
 1106  python main.py --env WizardOfWorNoFrameskip-v4 --algorithm ddqn --train --log_interval 100 --save_weight_interval 1000
 1107  ```
 1108  #### æ­¥éª¤ 5.6ï¼šè®­ç»ƒ Asterix
 1109  ```bash
 1110  # DQN
 1111  python main.py --env AsterixNoFrameskip-v4 --algorithm dqn --train --log_interval 100 --save_weight_interval 1000
 1112  # Double DQN
 1113  python main.py --env AsterixNoFrameskip-v4 --algorithm ddqn --train --log_interval 100 --save_weight_interval 1000
 1114  ```
 1115  ---
 1116  ### â±ï¸ é¢„è®¡è®­ç»ƒæ—¶é—´
 1117  | é¡¹ç›® | æ—¶é—´ï¼ˆRTX 3090ï¼‰ |
 1118  |------|-----------------|
 1119  | æ¯ä¸ªå®žéªŒ | çº¦ 10-20 å°æ—¶ |
 1120  | å…¨éƒ¨12ä¸ªå®žéªŒ | çº¦ 5-10 å¤© |
 1121  ---
 1122  ## 6. ç”Ÿæˆå›¾3
 1123  > ðŸŽ¯ **ç›®æ ‡**ï¼šè®­ç»ƒå®ŒæˆåŽï¼Œç”Ÿæˆè®ºæ–‡å›¾3çš„å¤çŽ°å›¾
 1124  ### æ­¥éª¤ 6.1ï¼šæŸ¥çœ‹ TensorBoardï¼ˆå®žæ—¶ç›‘æŽ§ï¼‰
 1125  ```bash
 1126  tensorboard --logdir=./log/ --host 0.0.0.0 --port 6006
 1127  ```
 1128  è®¿é—®ï¼šhttp://localhost:6006/
 1129  ### æ­¥éª¤ 6.2ï¼šç”Ÿæˆå›¾3
 1130  ```bash
 1131  python plot_figure3.py
 1132  ```
 1133  è¾“å‡ºæ–‡ä»¶ï¼š`./figure3_reproduction.png`
 1134  ---
 1135  ## 7. å¸¸è§é—®é¢˜
 1136  ### âŒ ROM is missing
 1137  ```bash
 1138  pip install autorom[accept-rom-license] -i https://pypi.tuna.tsinghua.edu.cn/simple
 1139  AutoROM --accept-license
 1140  python -m atari_py.import_roms /root/miniconda3/envs/deep/lib/python3.8/site-packages/AutoROM/roms
 1141  ```
 1142  ### âŒ DNN library is not found
 1143  ```bash
 1144  pip install nvidia-cudnn-cu11==8.6.0.163 -i https://pypi.tuna.tsinghua.edu.cn/simple
 1145  export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:/root/miniconda3/envs/deep/lib/python3.8/site-packages/nvidia/cudnn/lib:/root/miniconda3/envs/deep/lib/python3.8/site-packages/nvidia/cublas/lib
 1146  ```
 1147  ---
 1148  ## ðŸ“š å‚è€ƒ
 1149  - è®ºæ–‡ï¼š[arXiv:1509.06461](https://arxiv.org/abs/1509.06461)
 1150  - é¡¹ç›®æ–‡ä»¶ï¼š
 1151    - `main.py` - è®­ç»ƒå…¥å£ï¼Œæ”¯æŒ `--algorithm dqn/ddqn`
 1152    - `reproduce_figure3.sh` - ä¸€é”®å¤çŽ°è„šæœ¬
 1153    - `plot_figure3.py` - ç»˜åˆ¶å›¾3
 1154  ENDOFFILE
 1155  sed -n '250,290p' /root/genomix/genomix/models/genomix_modeling.py
 1156  sed -n '260,280p' /root/genomix/genomix/models/genomix_modeling.py
 1157  grep -n "Failed to import Triton" /root/genomix/genomix/models/genomix_modeling.py
 1158  sed -n '160,200p' /root/genomix/genomix/models/genomix_modeling.py
 1159  sed -n '1,50p' /root/genomix/genomix/models/genomix_modeling.py
 1160  sed -n '50,120p' /root/genomix/genomix/models/genomix_modeling.py
 1161  grep -n "fused_add_norm" /root/genomix/genomix/models/genomix_config.py 2>/dev/null | head -20
 1162  sed -n '260,290p' /root/genomix/genomix/models/genomix_modeling.py
 1163  sed -n '1,50p' /root/genomix/genomix/models/genomix_modeling.py
 1164  sed -n '50,120p' /root/genomix/genomix/models/genomix_modeling.py
 1165  sed -n '180,280p' /root/genomix/genomix/models/genomix_modeling.py
 1166  sed -n '140,185p' /root/genomix/genomix/models/genomix_modeling.py
 1167  sed -i 's/if self.fused_add_norm:/if self.fused_add_norm:\n            if layer_norm_fn is None or rms_norm_fn is None:\n                logger.warning("Triton LayerNorm \/ RMSNorm kernels not available. Disabling fused_add_norm.")\n                self.fused_add_norm = False\n                config.fused_add_norm = False\n        if self.fused_add_norm and False:  # disabled check/' /root/genomix/genomix/models/genomix_modeling.py
 1168  python3 << 'EOF'
 1169  import re
 1170  file_path = '/root/genomix/genomix/models/genomix_modeling.py'
 1171  with open(file_path, 'r') as f:
 1172      content = f.read()
 1173  # æ‰¾åˆ°éœ€è¦ä¿®æ”¹çš„ä»£ç å—
 1174  old_code = '''        self.fused_add_norm = config.fused_add_norm
 1175          if self.fused_add_norm:
 1176              if layer_norm_fn is None or rms_norm_fn is None:
 1177                  raise ImportError("Failed to import Triton LayerNorm / RMSNorm kernels")'''
 1178  new_code = '''        self.fused_add_norm = config.fused_add_norm
 1179          if self.fused_add_norm:
 1180              if layer_norm_fn is None or rms_norm_fn is None:
 1181                  logger.warning("Triton LayerNorm / RMSNorm kernels not available. Disabling fused_add_norm.")
 1182                  self.fused_add_norm = False
 1183                  config.fused_add_norm = False'''
 1184  if old_code in content:
 1185      content = content.replace(old_code, new_code)
 1186      with open(file_path, 'w') as f:
 1187          f.write(content)
 1188      print("ä¿®æ”¹æˆåŠŸï¼")
 1189  else:
 1190      print("æœªæ‰¾åˆ°ç›®æ ‡ä»£ç å—ï¼Œå¯èƒ½å·²ç»è¢«ä¿®æ”¹è¿‡")
 1191      # æ‰“å°ç›¸å…³è¡Œ
 1192      lines = content.split('\n')
 1193      for i, line in enumerate(lines):
 1194          if 'fused_add_norm' in line and i > 150:
 1195              print(f"Line {i+1}: {line}")
 1196  EOF
 1197  sed -n '175,185p' /root/genomix/genomix/models/genomix_modeling.py
 1198  python3 << 'EOF'
 1199  file_path = '/root/genomix/genomix/models/genomix_modeling.py'
 1200  with open(file_path, 'r') as f:
 1201      content = f.read()
 1202  # åˆ é™¤å¤šä½™çš„ä»£ç å—
 1203  old_code = '''        self.fused_add_norm = config.fused_add_norm
 1204          if self.fused_add_norm:
 1205              if layer_norm_fn is None or rms_norm_fn is None:
 1206                  logger.warning("Triton LayerNorm / RMSNorm kernels not available. Disabling fused_add_norm.")
 1207                  self.fused_add_norm = False
 1208                  config.fused_add_norm = False
 1209          if self.fused_add_norm and False:  # disabled check
 1210              if layer_norm_fn is None or rms_norm_fn is None:
 1211                  raise ImportError("Failed to import Triton LayerNorm / RMSNorm kernels")'''
 1212  new_code = '''        self.fused_add_norm = config.fused_add_norm
 1213          if self.fused_add_norm:
 1214              if layer_norm_fn is None or rms_norm_fn is None:
 1215                  logger.warning("Triton LayerNorm / RMSNorm kernels not available. Disabling fused_add_norm.")
 1216                  self.fused_add_norm = False
 1217                  config.fused_add_norm = False'''
 1218  if old_code in content:
 1219      content = content.replace(old_code, new_code)
 1220      with open(file_path, 'w') as f:
 1221          f.write(content)
 1222      print("ä¿®æ”¹æˆåŠŸï¼")
 1223  else:
 1224      print("æœªæ‰¾åˆ°ç›®æ ‡ä»£ç å—")
 1225  EOF
 1226  sed -n '173,190p' /root/genomix/genomix/models/genomix_modeling.py
 1227  grep -n "RMSNorm" /root/genomix/genomix/models/genomix_modeling.py | head -20
 1228  sed -n '235,245p' /root/genomix/genomix/models/genomix_modeling.py
 1229  sed -n '348,360p' /root/genomix/genomix/models/genomix_modeling.py
 1230  python3 << 'EOF'
 1231  file_path = '/root/genomix/genomix/models/genomix_modeling.py'
 1232  with open(file_path, 'r') as f:
 1233      content = f.read()
 1234  # 1. ä¿®å¤ RMSNorm å¯¼å…¥é—®é¢˜ - å½“ RMSNorm ä¸º None æ—¶ä½¿ç”¨ nn.LayerNorm
 1235  old_code1 = '''        # norm layer
 1236          self.norm_f = (nn.LayerNorm if not config.rms_norm else RMSNorm)(
 1237              config.d_model, eps=config.norm_epsilon, **factory_kwargs
 1238          )'''
 1239  new_code1 = '''        # norm layer
 1240          # If RMSNorm is not available (Triton not installed), fall back to LayerNorm
 1241          if config.rms_norm and RMSNorm is None:
 1242              logger.warning("RMSNorm not available (Triton not installed). Using LayerNorm instead.")
 1243              config.rms_norm = False
 1244          self.norm_f = (nn.LayerNorm if not config.rms_norm else RMSNorm)(
 1245              config.d_model, eps=config.norm_epsilon, **factory_kwargs
 1246          )'''
 1247  # 2. ä¿®å¤ isinstance æ£€æŸ¥é—®é¢˜
 1248  old_code2 = '''                is_rms_norm=isinstance(self.norm_f, RMSNorm)'''
 1249  new_code2 = '''                is_rms_norm=(RMSNorm is not None and isinstance(self.norm_f, RMSNorm))'''
 1250  modified = False
 1251  if old_code1 in content:
 1252      content = content.replace(old_code1, new_code1)
 1253      print("ä¿®å¤1: RMSNorm å›žé€€åˆ° LayerNorm - æˆåŠŸ")
 1254      modified = True
 1255  else:
 1256      print("ä¿®å¤1: æœªæ‰¾åˆ°ç›®æ ‡ä»£ç å—")
 1257  if old_code2 in content:
 1258      content = content.replace(old_code2, new_code2)
 1259      print("ä¿®å¤2: isinstance æ£€æŸ¥ - æˆåŠŸ")
 1260      modified = True
 1261  else:
 1262      print("ä¿®å¤2: æœªæ‰¾åˆ°ç›®æ ‡ä»£ç å—")
 1263  if modified:
 1264      with open(file_path, 'w') as f:
 1265          f.write(content)
 1266      print("\næ–‡ä»¶å·²ä¿å­˜ï¼")
 1267  EOF
 1268  grep -n "layer_norm_fn\|rms_norm_fn\|RMSNorm\|triton" /root/genomix/genomix/models/genomix_block.py 2>/dev/null | head -30
 1269  sed -n '195,280p' /root/genomix/genomix/models/genomix_block.py
 1270  sed -n '285,340p' /root/genomix/genomix/models/genomix_block.py
 1271  python3 << 'EOF'
 1272  import logging
 1273  file_path = '/root/genomix/genomix/models/genomix_block.py'
 1274  with open(file_path, 'r') as f:
 1275      content = f.read()
 1276  modifications = []
 1277  # 1. ä¿®å¤ fused_add_norm æ£€æŸ¥ - åˆ é™¤ assert å¹¶æ”¹ä¸ºè­¦å‘Š
 1278  old_code1 = '''        if self.fused_add_norm:
 1279              assert RMSNorm is not None, "RMSNorm import fails"
 1280              assert isinstance(
 1281                  self.norm, (nn.LayerNorm, RMSNorm)
 1282              ), "Only LayerNorm and RMSNorm are supported for fused_add_norm"'''
 1283  new_code1 = '''        if self.fused_add_norm:
 1284              if RMSNorm is None or layer_norm_fn is None:
 1285                  logger.warning("Triton LayerNorm/RMSNorm not available. Disabling fused_add_norm in block.")
 1286                  self.fused_add_norm = False'''
 1287  if old_code1 in content:
 1288      content = content.replace(old_code1, new_code1)
 1289      modifications.append("ä¿®å¤1: fused_add_norm assert æ£€æŸ¥")
 1290  # 2. ä¿®å¤ isinstance æ£€æŸ¥ - forward æ–¹æ³•ä¸­ç¬¬ä¸€å¤„
 1291  old_code2 = '''                is_rms_norm=isinstance(self.norm, RMSNorm)'''
 1292  new_code2 = '''                is_rms_norm=(RMSNorm is not None and isinstance(self.norm, RMSNorm))'''
 1293  if old_code2 in content:
 1294      content = content.replace(old_code2, new_code2)
 1295      modifications.append("ä¿®å¤2: isinstance(self.norm, RMSNorm) æ£€æŸ¥")
 1296  # 3. ä¿®å¤ isinstance æ£€æŸ¥ - forward æ–¹æ³•ä¸­ norm2 å¤„
 1297  old_code3 = '''                    is_rms_norm=isinstance(self.norm2, RMSNorm)'''
 1298  new_code3 = '''                    is_rms_norm=(RMSNorm is not None and isinstance(self.norm2, RMSNorm))'''
 1299  if old_code3 in content:
 1300      content = content.replace(old_code3, new_code3)
 1301      modifications.append("ä¿®å¤3: isinstance(self.norm2, RMSNorm) æ£€æŸ¥")
 1302  # 4. ä¿®å¤ norm åˆå§‹åŒ–æ—¶ RMSNorm ä¸º None çš„æƒ…å†µ - ç¬¬ä¸€å¤„
 1303  old_code4 = '''        # define norm layer
 1304          self.norm  = (nn.LayerNorm if not rms_norm else RMSNorm)(
 1305              d_model,
 1306              eps=norm_epsilon, 
 1307              **factory_kwargs
 1308          )'''
 1309  new_code4 = '''        # define norm layer
 1310          # If RMSNorm is not available (Triton not installed), fall back to LayerNorm
 1311          if rms_norm and RMSNorm is None:
 1312              logger.warning("RMSNorm not available. Using LayerNorm instead.")
 1313              rms_norm = False
 1314          self.norm  = (nn.LayerNorm if not rms_norm else RMSNorm)(
 1315              d_model,
 1316              eps=norm_epsilon, 
 1317              **factory_kwargs
 1318          )'''
 1319  if old_code4 in content:
 1320      content = content.replace(old_code4, new_code4)
 1321      modifications.append("ä¿®å¤4: self.norm åˆå§‹åŒ– RMSNorm å›žé€€")
 1322  # 5. ä¿®å¤ norm2 åˆå§‹åŒ–æ—¶ RMSNorm ä¸º None çš„æƒ…å†µ
 1323  old_code5 = '''                self.norm2 = (nn.LayerNorm if not rms_norm else RMSNorm)(
 1324                      d_model,
 1325                      eps=norm_epsilon, 
 1326                      **factory_kwargs
 1327                  )'''
 1328  new_code5 = '''                self.norm2 = (nn.LayerNorm if not rms_norm else RMSNorm)(
 1329                      d_model,
 1330                      eps=norm_epsilon, 
 1331                      **factory_kwargs
 1332                  ) if RMSNorm is not None or not rms_norm else nn.LayerNorm(
 1333                      d_model,
 1334                      eps=norm_epsilon, 
 1335                      **factory_kwargs
 1336                  )'''
 1337  # è¿™ä¸ªä¿®æ”¹å¯èƒ½ä¼šå¯¼è‡´ä»£ç å¤æ‚ï¼Œæ”¹ç”¨æ›´ç®€å•çš„æ–¹å¼ - åœ¨å‰é¢å·²ç»å¤„ç†è¿‡ rms_norm çš„å›žé€€
 1338  if modifications:
 1339      with open(file_path, 'w') as f:
 1340          f.write(content)
 1341      print("å·²åº”ç”¨çš„ä¿®æ”¹ï¼š")
 1342      for m in modifications:
 1343          print(f"  - {m}")
 1344      print("\næ–‡ä»¶å·²ä¿å­˜ï¼")
 1345  else:
 1346      print("æœªæ‰¾åˆ°éœ€è¦ä¿®æ”¹çš„ä»£ç å—")
 1347  EOF
 1348  sed -n '265,280p' /root/genomix/genomix/models/genomix_block.py
 1349  grep -n "^import logging\|^logger = " /root/genomix/genomix/models/genomix_block.py | head -5
 1350  mkdir -p /DW/AI_models/wangyuxuan2/projects/
 1351  ls
 1352  cd /DW/AI_models/wangyuxuan2/projects/
 1353  pwd
 1354  cd /
 1355  ls
 1356  nvidia-smi
 1357  cd /root/Deep
 1358  history
 1359  history >> å‘½ä»¤.txt
